| Supported Targets | ESP32 |
| ----------------- | ----- |

# ESP32 Continuous ADC & Wi-Fi Communication Project - Energy Meeter

## Overview

This project demonstrates the use of the ESP32 for continuous analog data acquisition across multiple ADC channels, applying digital filters (Butterworth and Thiran) for signal conditioning, and establishing Wi-Fi communication with a PC. The system uses UDP broadcasting to announce its presence and receive a selection from a PC. Once selected, it switches to unicast communication for data transmission.

## Features

* Continuous ADC Acquisition: Captures analog data from multiple channels.
* Digital Filtering: Applies Butterworth and Thiran filters to improve signal quality.
* Wi-Fi Connectivity: Manages connection to Wi-Fi with automatic reconnection on failures.
* UDP Communication:
    * Broadcast: Periodically sends the ESP32's IP and MAC address for device discovery.
    * Unicast: Initiates targeted communication with a selected PC to transmit data.
* Modular Design: Separates functionalities into dedicated tasks (ADC processing, Wi-Fi connection, and UDP communication).

## Prerequisites

### Hardware
* ESP32.
* Sensors connected to the ADC channels, as required by your application (3 Voltage probes + 3 Current Probes).

### Software
* [ESP-IDF](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/) (compatible version for your hardware).
* [Processing 4](https://processing.org/download) - [ESP32-Energy-Meeter-GUI](https://github.com/TonioCaldeira/ESP32-Energy-Meeter-GUI)

### Configuration
* ADC parameters, Wi-Fi settings, and UDP communication options are defined in `config.h`.


## Getting Started
### Environment Setup
1. Clone the repository: VERIFICAR
```
git clone https://github.com/TonioCaldeira/esp32-Energy-Meeter.git
cd esp32-Energy-Meeter
```
2. Set up the ESP-IDF environment (refer to the [ESP-IDF Setup Guide](https://docs.espressif.com/projects/esp-idf/en/stable/esp32/get-started/index.html)).

3. Select Port (COM, tty, usbserial).

4. Set Device Target (IDF_TARGET).

5. Configure project parameters:
```
idf.py menuconfig
```
* Pin Wi-Fi to `Core-1`
* Enable `Detect flash size when flashing bootloader`
* Enable `WiFi IRAM speed optimization`
* Enable `WiFi EXTRA IRAM speed optimization`
* Enable `WiFi RX IRAM speed optimization`

### Build and Flash
1. Build the project:
```
idf.py build
```
2. Flash the project onto the ESP32:
```
idf.py flash
```
3. Monitor the output:
```
idf.py monitor
```

## Code Structure
### Main
* `EnergyMeeter.c`: Main entry point for the application, initializes system components and starts tasks.
* `adc_continuous_task.c`: Handles continuous ADC data acquisition, processing (including applying Butterworth and Thiran filters), and data formatting.

### Communication
* `wifi_connect.c`: Manages Wi-Fi connection, event handling, and automatic reconnections.
* `com_task.c`: Manages communication tasks, including listening for PC selection and starting unicast communication.
* `udp_cast_task.c`: Implements UDP communication, performing broadcasts for device discovery and initiating unicast communication upon selection.

### Filters
* `butterworth_filter.c`: Implements the Butterworth filter for signal processing.
* `thiran_filter.c`: Implements the Thiran filter for signal processing.

### Configuration Files
* `config.h`: Contains configuration parameters such as sampling rate, UDP ports, filtering options, and more.
* `sdkconfig`: Configuration file generated by `menuconfig` that contains all the build settings.
* `sdkconfig.defaults`: Default configuration settings to ensure specific parameters are set during the build process.
* `sdkconfig.ci`: Configuration settings used for Continuous Integration (CI) builds.
* `CMakeLists.txt`: CMake build configuration file.


## Usage
1. On boot, the ESP32 connects to the configured Wi-Fi network.
2. The device periodically broadcasts its IP and MAC address.
3. A PC or monitoring system selects the ESP32 for communication.
    * [ESP32-Energy-Meeter-GUI](https://github.com/TonioCaldeira/ESP32-Energy-Meeter-GUI) Is recommended for this task
4. Once selected, the ESP32 switches to unicast communication with the PC and starts transmitting the processed data.

## Troubleshooting
* Wi-Fi Connection Issues: Ensure that the SSID and password are correctly set in the menuconfig, if possible.
    * Usualy this parameters are defined in `config.h`
* ADC Data Acquisition Errors: Verify sensor connections and calibration parameters defined in `config.h`.
* UDP Communication Failures: Check that there are no network restrictions or firewalls blocking UDP traffic.
